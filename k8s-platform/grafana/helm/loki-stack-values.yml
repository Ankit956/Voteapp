loki:
  enabled: true
  image:
    tag: 2.6.1
  config:
    ingester:
      wal:
        dir: /data/loki/wal

promtail:
  enabled: true
  image:
    tag: 2.9.5

fluent-bit:
  enabled: false
  image:
    tag: 2.9.5

grafana:
  enabled: true
  image:
    registry: docker.io
    repository: grafana/grafana-oss
    tag: 10.2.4
  service:
    type: ClusterIP
  # See: https://github.com/grafana/helm-charts/issues/1746
  rbac:
    pspEnabled: false
  testFramework:
    enabled: false
  sidecar:
    dashboards:
      enabled: true
      provider:
        allowUiUpdates: true
    datasources:
      enabled: false
  datasources:
    "datasources.yaml":
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          uid: prometheus
          access: proxy
          url: http://loki-stack-prometheus-server
          basicAuth: false
          isDefault: false
          version: 1
          editable: true
          jsonData:
            httpMethod: POST
            exemplarTraceIdDestinations:
              - name: traceID
                datasourceUid: tempo
        - name: Tempo
          type: tempo
          uid: tempo
          access: proxy
          url: http://tempo:3100
          basicAuth: false
          isDefault: false
          version: 1
          editable: true
          jsonData:
            httpMethod: GET
            tracesToMetrics:
              datasourceUid: prometheus
              tags: [ { key: 'service.name', value: 'application' }, { key: 'org' }, { key: 'method' }, { key: 'uri' }, { key: 'outcome' }, { key: 'status' }, { key: 'exception' } ]
              queries:
                - name: 'Throughput'
                  query: 'sum(rate(http_server_requests_seconds_count{$$__tags}[$$__rate_interval]))'
                - name: 'Latency'
                  query: 'histogram_quantile(1.00, sum(rate(http_server_requests_seconds_bucket{$$__tags}[$$__rate_interval])) by (le))'
            tracesToLogs:
              datasourceUid: 'loki'
              tags: [ 'instance', 'pod', 'namespace', 'hostname' ]
              mappedTags: [ { key: 'org' }, { key: 'service.name', value: 'application' }  ]
              mapTagNamesEnabled: true
              spanStartTimeShift: '1h'
              spanEndTimeShift: '1h'
              filterByTraceID: true
              filterBySpanID: false
              lokiSearch: true
            lokiSearch:
              datasourceUid: loki
            serviceMap:
              datasourceUid: prometheus
            search:
              hide: false
            nodeGraph:
              enabled: true
        - name: Loki
          type: loki
          uid: loki
          access: proxy
          url: http://loki-stack:3100
          basicAuth: false
          isDefault: true
          version: 1
          editable: true
          jsonData:
            derivedFields:
              - datasourceUid: tempo
                matcherRegex: '.+ --- \[.+\] \[.+\] \[(\w*)-\w*\] .+'
                name: traceId
                url: $${__value.raw}

prometheus:
  enabled: true
  alertmanager:
    enabled: false
  configmapReload:
    alertmanager:
      enabled: false
  kube-state-metrics:
    metricLabelsAllowlist:
      - pods=[*]
      - deployments=[app.kubernetes.io/name,app.kubernetes.io/component,app.kubernetes.io/instance]
  pushgateway:
    enabled: false
  server:
    global:
      scrape_interval: 15s
    image:
      repository: quay.io/prometheus/prometheus
      tag: v2.50.1
    persistentVolume:
      enabled: false
