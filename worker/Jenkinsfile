pipeline{ 
    agent{ 
      docker{ 
        image 'maven:3.8.5-jdk-11-slim' 
        args '-v $HOME/.m2:/root/.m2' 
      } 
    } 
    environment{
      DOCKERHUB_CREDENTIALS=credentials('dockerjenkins')
    }
    stages{ 
        stage('build'){ 
            steps{ 
                echo 'building worker app' 
                dir('worker'){ 
                  sh 'mvn compile' 
                } 
            } 
        } 
        stage('test'){ 
            steps{
                echo 'running unit tests on worker app' 
                dir('worker'){ 
                  sh 'mvn clean test' 
                } 
            } 
        } 
        stage('package'){ 
            steps{ 
                echo 'packaging worker app into a jarfile'
                dir('worker'){ 
                  sh 'mvn package -DskipTests' 
                  archiveArtifacts artifacts: '**/target/*.jar', fingerprint:  true 
                } 
            } 
        } 
        stage('Login') {
      steps {
        sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
      }
    }
        stage('docker-package'){ 
            agent any 
            steps{ 
              echo 'Packaging worker app with docker' 
              script{
                    def workerImage = docker.build('okapetanios/worker:v$ {env.BUILD_ID}', './worker') 
                    workerImage.push() 
                    workerImage.push("latest") 
                
              } 
            } 
        } 
    } 
    post{ 
        always{ 
            echo 'the job is complete' 
        } 
    }
}  